# ai-review å°ˆæ¡ˆè§£èªªèˆ‡ Go èªè¨€å…¥é–€æŒ‡å—

<a id="ç›®éŒ„"></a>

## ğŸ“‘ ç›®éŒ„

- [å°ˆæ¡ˆæ¦‚è¦½](#å°ˆæ¡ˆæ¦‚è¦½)
- [Go èªè¨€åŸºç¤æ¦‚å¿µ](#go-èªè¨€åŸºç¤æ¦‚å¿µ)
  - [Package èˆ‡ç¨‹å¼é€²å…¥é»](#1-packageå¥—ä»¶èˆ‡ç¨‹å¼é€²å…¥é»)
  - [Import å¼•å…¥å¤–éƒ¨å¥—ä»¶](#2-importå¼•å…¥å¤–éƒ¨å¥—ä»¶)
  - [Struct çµæ§‹é«”](#3-structçµæ§‹é«”--go-çš„ç‰©ä»¶)
  - [å»ºæ§‹å‡½å¼](#4-å»ºæ§‹å‡½å¼æ…£ä¾‹ç”¨-new-é–‹é ­)
  - [Method æ–¹æ³•](#5-methodæ–¹æ³•--å‡½å¼ç¶å®šåˆ°çµæ§‹é«”)
  - [Interface ä»‹é¢](#6-interfaceä»‹é¢--go-çš„å¤šå‹æ©Ÿåˆ¶)
  - [The Elm Architecture](#7-the-elm-architecturetea--æ ¸å¿ƒè¨­è¨ˆæ¨¡å¼)
  - [Type Switch](#8-type-switch-èˆ‡-type-assertion)
  - [Closure é–‰åŒ…](#9-closureé–‰åŒ…èˆ‡-teacmd-æ¨¡å¼)
  - [è‡ªè¨‚å‹åˆ¥èˆ‡ Msg æ¨¡å¼](#10-è‡ªè¨‚å‹åˆ¥èˆ‡-msg-æ¨¡å¼)
  - [åˆ‡ç‰‡æ“ä½œ](#11-åˆ‡ç‰‡æ“ä½œslice)
  - [éŒ¯èª¤è™•ç†](#12-éŒ¯èª¤è™•ç†--go-çš„ç¨ç‰¹å“²å­¸)
  - [è®Šæ•¸å®£å‘Š](#13-è®Šæ•¸å®£å‘Šçš„å¤šç¨®æ–¹å¼)
  - [éˆå¼æ–¹æ³•å‘¼å«](#14-éˆå¼æ–¹æ³•å‘¼å«method-chaining)
- [å°ˆæ¡ˆæ¶æ§‹ç¸½çµ](#å°ˆæ¡ˆæ¶æ§‹ç¸½çµ)
- [ç¨‹å¼åŸ·è¡Œæµç¨‹](#ç¨‹å¼åŸ·è¡Œæµç¨‹)

---

## å°ˆæ¡ˆæ¦‚è¦½

ai-review æ˜¯ä¸€å€‹ **AI CLI è¼¸å‡ºæ¨™è¨»å·¥å…·**ã€‚ç•¶ä½ ä½¿ç”¨ Claude CLIã€Gemini ç­‰ AI å·¥å…·æ™‚ï¼ŒAI æœƒåå‡ºå¤§é‡æ–‡å­—ï¼Œé€™å€‹å·¥å…·è®“ä½ èƒ½ã€Œæ¨™è¨˜ã€é‡è¦çš„è¡Œã€åŠ ä¸Šç­†è¨˜ã€æœ€å¾ŒåŒ¯å‡ºã€‚

é‹ä½œæ–¹å¼ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å·¦é‚Šçª—æ ¼ (AI CLI)           â”‚  å³é‚Šçª—æ ¼ (æ¨™è¨»é¢æ¿) â”‚
â”‚                             â”‚                  â”‚
â”‚  $ claude                   â”‚  â–¶ 1  AI çš„è¼¸å‡º...  â”‚
â”‚  > å¹«æˆ‘å¯«ä¸€å€‹å‡½å¼...          â”‚    2  â— é€™è¡Œè¢«æ¨™è¨˜äº† â”‚
â”‚  ...                        â”‚    3  ...          â”‚
â”‚                             â”‚  Marks (1)        â”‚
â”‚                             â”‚  L2 é€™è¡Œè¢«æ¨™è¨˜äº†     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           tmux session: "ai-review"
```

ä½¿ç”¨ **tmux**ï¼ˆçµ‚ç«¯æ©Ÿå¤šå·¥å™¨ï¼‰å°‡ç•«é¢åˆ†æˆå·¦å³å…©åŠï¼Œå·¦é‚Šè·‘ AI CLIï¼Œå³é‚Šè·‘æ¨™è¨»é¢æ¿ TUIã€‚

[â¬† å›åˆ°ç›®éŒ„](#ç›®éŒ„)

---

## Go èªè¨€åŸºç¤æ¦‚å¿µ

### 1. Packageï¼ˆå¥—ä»¶ï¼‰èˆ‡ç¨‹å¼é€²å…¥é»

> å°æ‡‰æª”æ¡ˆï¼š`main.go`

```go
package main  // æ¯å€‹ Go æª”æ¡ˆéƒ½å±¬æ–¼ä¸€å€‹ package
              // "main" æ˜¯ç‰¹æ®Šçš„â€”â€”å®ƒä»£è¡¨ã€Œå¯åŸ·è¡Œç¨‹å¼ã€

func main() { // main å¥—ä»¶è£¡çš„ main å‡½å¼ = ç¨‹å¼é€²å…¥é»ï¼ˆåƒ C çš„ mainï¼‰
    // ç¨‹å¼å¾é€™è£¡é–‹å§‹åŸ·è¡Œ
}
```

**é‡é»æ¦‚å¿µï¼š** é€™å€‹å°ˆæ¡ˆæœ‰ 8 å€‹ `.go` æª”æ¡ˆï¼Œä½†å®ƒå€‘å…¨éƒ½å¯« `package main`ã€‚Go çš„è¦å‰‡æ˜¯ï¼š**åŒä¸€å€‹ç›®éŒ„ä¸‹çš„æ‰€æœ‰æª”æ¡ˆå¿…é ˆå±¬æ–¼åŒä¸€å€‹ package**ï¼Œç·¨è­¯å™¨æœƒæŠŠå®ƒå€‘åˆåœ¨ä¸€èµ·ã€‚æ‰€ä»¥ `model.go` å®šç¾©çš„ `Model` çµæ§‹é«”ï¼Œåœ¨ `view.go` è£¡å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œä¸éœ€è¦ importã€‚

[â¬† å›åˆ°ç›®éŒ„](#ç›®éŒ„)

---

### 2. Importï¼ˆå¼•å…¥å¤–éƒ¨å¥—ä»¶ï¼‰

> å°æ‡‰æª”æ¡ˆï¼š`main.go`ã€`go.mod`

```go
import (
    "fmt"      // æ¨™æº–å‡½å¼åº«ï¼šæ ¼å¼åŒ–è¼¸å‡ºï¼ˆåƒ printfï¼‰
    "os"       // æ¨™æº–å‡½å¼åº«ï¼šä½œæ¥­ç³»çµ±æ“ä½œï¼ˆç’°å¢ƒè®Šæ•¸ã€é€²ç¨‹ç­‰ï¼‰
    "os/exec"  // æ¨™æº–å‡½å¼åº«ï¼šåŸ·è¡Œå¤–éƒ¨æŒ‡ä»¤

    // ç¬¬ä¸‰æ–¹å¥—ä»¶ï¼Œç”¨ URL è·¯å¾‘è¡¨ç¤ºï¼ˆGo çš„ç¨ç‰¹è¨­è¨ˆï¼‰
    tea "github.com/charmbracelet/bubbletea"  // åˆ¥å importï¼šæŠŠé•·åå­—ç°¡å¯«ç‚º "tea"
)
```

Go çš„å¥—ä»¶ç®¡ç†ç”¨ `go.mod` æª”æ¡ˆï¼ˆé¡ä¼¼ Node.js çš„ `package.json`ï¼‰ï¼š

```go
module github.com/scheep-yang/ai-review  // é€™å€‹å°ˆæ¡ˆçš„æ¨¡çµ„åç¨±
go 1.24.4                                 // Go ç‰ˆæœ¬

require (
    github.com/charmbracelet/bubbletea v1.3.10  // TUI æ¡†æ¶
    github.com/charmbracelet/lipgloss v1.1.0    // çµ‚ç«¯æ¨£å¼ï¼ˆé¡è‰²ã€é‚Šæ¡†ï¼‰
    github.com/atotto/clipboard v0.1.4          // å‰ªè²¼ç°¿æ“ä½œ
)
```

[â¬† å›åˆ°ç›®éŒ„](#ç›®éŒ„)

---

### 3. Structï¼ˆçµæ§‹é«”ï¼‰â€” Go çš„ã€Œç‰©ä»¶ã€

> å°æ‡‰æª”æ¡ˆï¼š`model.go:20-39`

Go æ²’æœ‰ classï¼Œç”¨ **struct** ä»£æ›¿ï¼š

```go
type Model struct {
    lines      []string        // []string = string çš„åˆ‡ç‰‡ï¼ˆå‹•æ…‹é™£åˆ—ï¼‰
    noteInput  textarea.Model  // åµŒå…¥å¦ä¸€å€‹çµæ§‹é«”ï¼ˆçµ„åˆ > ç¹¼æ‰¿ï¼‰
    marks      []Mark          // Mark çš„åˆ‡ç‰‡
    cursorLine int             // int å‹åˆ¥ï¼Œé è¨­å€¼ 0
    inputMode  bool            // bool å‹åˆ¥ï¼Œé è¨­å€¼ false
    width      int
    height     int
    statusMsg  string          // string å‹åˆ¥ï¼Œé è¨­å€¼ ""ï¼ˆç©ºå­—ä¸²ï¼‰
    tmuxPane   string
    // ...
}
```

**Go çš„è¨­è¨ˆå“²å­¸ï¼š**

- **æ²’æœ‰ç¹¼æ‰¿**ï¼Œåªæœ‰**çµ„åˆ**ï¼ˆComposition over Inheritanceï¼‰
- æ¬„ä½åç¨±**å°å¯«é–‹é ­ = ç§æœ‰**ï¼ˆåªæœ‰åŒ package å¯å­˜å–ï¼‰ï¼Œ**å¤§å¯«é–‹é ­ = å…¬é–‹**
- ä¾‹å¦‚ `lines` æ˜¯ç§æœ‰çš„ï¼Œä½† `Mark` çµæ§‹é«”è£¡çš„ `Line`ã€`Text`ã€`Note` æ˜¯å…¬é–‹çš„

[â¬† å›åˆ°ç›®éŒ„](#ç›®éŒ„)

---

### 4. å»ºæ§‹å‡½å¼ï¼ˆæ…£ä¾‹ç”¨ `New` é–‹é ­ï¼‰

> å°æ‡‰æª”æ¡ˆï¼š`model.go:41-55`

Go æ²’æœ‰ constructor èªæ³•ï¼Œæ…£ä¾‹ç”¨ `NewXxx` å‡½å¼ï¼š

```go
func NewWatchModel(paneID string) Model {
    ta := textarea.New()                    // å‘¼å« textarea å¥—ä»¶çš„å»ºæ§‹å‡½å¼
    ta.Placeholder = "Enter note..."
    ta.CharLimit = 500
    ta.SetHeight(noteInputHeight)           // noteInputHeight æ˜¯å¸¸æ•¸ = 4
    ta.ShowLineNumbers = false

    return Model{                           // çµæ§‹é«”å­—é¢å€¼ï¼ˆstruct literalï¼‰
        lines:      []string{},             // ç©ºåˆ‡ç‰‡
        noteInput:  ta,
        marks:      []Mark{},
        splitRatio: 70,                     // å·¦é¢æ¿ä½” 70%
        tmuxPane:   paneID,
        // æ²’åˆ—å‡ºçš„æ¬„ä½ = é›¶å€¼ï¼ˆintâ†’0, boolâ†’false, stringâ†’""ï¼‰
    }
}
```

[â¬† å›åˆ°ç›®éŒ„](#ç›®éŒ„)

---

### 5. Methodï¼ˆæ–¹æ³•ï¼‰â€” å‡½å¼ç¶å®šåˆ°çµæ§‹é«”

> å°æ‡‰æª”æ¡ˆï¼š`marks.go:15-52`

Go ç”¨ **receiver** èªæ³•æŠŠå‡½å¼ç¶åœ¨çµæ§‹é«”ä¸Šï¼š

```go
// (m *Model) = æŒ‡æ¨™æ¥æ”¶è€…ï¼ˆpointer receiverï¼‰
// æ„æ€ï¼šé€™å€‹æ–¹æ³•å¯ä»¥ä¿®æ”¹ m çš„å…§å®¹
func (m *Model) ToggleMark(line int) {
    if m.HasMark(line) {
        m.RemoveMark(line)
        return                // Go çš„ return å¯ä»¥ä¸å¸¶å€¼ï¼ˆvoid functionï¼‰
    }
    text := truncate(m.lines[line], 60)
    m.marks = append(m.marks, Mark{Line: line, Text: text})
}

// (m Model) = å€¼æ¥æ”¶è€…ï¼ˆvalue receiverï¼‰
// æ„æ€ï¼šé€™å€‹æ–¹æ³•æ‹¿åˆ°çš„æ˜¯ m çš„å‰¯æœ¬ï¼Œä¸æœƒä¿®æ”¹åŸå§‹è³‡æ–™
func (m Model) HasMark(line int) bool {
    for _, mk := range m.marks {  // range = è¿­ä»£åˆ‡ç‰‡ï¼Œ_ å¿½ç•¥ç´¢å¼•
        if mk.Line == line {
            return true
        }
    }
    return false
}
```

**é—œéµå·®ç•°ï¼š**

| æ¥æ”¶è€… | èªæ³• | è¡Œç‚º | ä½¿ç”¨æ™‚æ©Ÿ |
|--------|------|------|----------|
| æŒ‡æ¨™ `*Model` | `func (m *Model) Foo()` | ä¿®æ”¹åŸå§‹è³‡æ–™ | éœ€è¦æ”¹è®Šç‹€æ…‹æ™‚ |
| å€¼ `Model` | `func (m Model) Foo()` | æ“ä½œå‰¯æœ¬ï¼Œä¸å½±éŸ¿åŸå§‹ | åªè®€æ“ä½œæ™‚ |

[â¬† å›åˆ°ç›®éŒ„](#ç›®éŒ„)

---

### 6. Interfaceï¼ˆä»‹é¢ï¼‰â€” Go çš„å¤šå‹æ©Ÿåˆ¶

> å°æ‡‰æª”æ¡ˆï¼š`model.go:57-59`ã€`update.go:13-49`ã€`view.go:36-93`

é€™å€‹å°ˆæ¡ˆä½¿ç”¨ **Bubble Tea** æ¡†æ¶ï¼Œå®ƒå®šç¾©äº†ä¸€å€‹ä»‹é¢ï¼š

```go
// æ¡†æ¶è¦æ±‚ä½ çš„ Model å¿…é ˆå¯¦ä½œé€™ä¸‰å€‹æ–¹æ³•ï¼š
type tea.Model interface {
    Init() tea.Cmd                         // åˆå§‹åŒ–
    Update(tea.Msg) (tea.Model, tea.Cmd)   // è™•ç†äº‹ä»¶
    View() string                          // æ¸²æŸ“ç•«é¢
}
```

**Go çš„ä»‹é¢æ˜¯éš±å¼å¯¦ä½œçš„**ï¼ˆé´¨å­å‹åˆ¥ï¼ŒDuck Typingï¼‰ï¼šä½ ä¸éœ€è¦å¯« `implements`ï¼Œåªè¦çµæ§‹é«”æœ‰é€™ä¸‰å€‹æ–¹æ³•ï¼Œå®ƒå°±è‡ªå‹•æ»¿è¶³ `tea.Model` ä»‹é¢ã€‚

åœ¨é€™å€‹å°ˆæ¡ˆè£¡ï¼š

| æ–¹æ³• | ä½ç½® | è·è²¬ |
|------|------|------|
| `Init()` | `model.go:57-59` | åˆå§‹åŒ–ï¼ˆæœ¬å°ˆæ¡ˆå›å‚³ nilï¼Œç„¡éœ€å•Ÿå‹•æŒ‡ä»¤ï¼‰ |
| `Update()` | `update.go:13-49` | æ¥æ”¶äº‹ä»¶è¨Šæ¯ï¼Œå›å‚³æ–°çš„ Model ç‹€æ…‹ |
| `View()` | `view.go:36-93` | æ ¹æ“š Model ç‹€æ…‹æ¸²æŸ“å‡ºçµ‚ç«¯ç•«é¢å­—ä¸² |

[â¬† å›åˆ°ç›®éŒ„](#ç›®éŒ„)

---

### 7. The Elm Architectureï¼ˆTEAï¼‰â€” æ ¸å¿ƒè¨­è¨ˆæ¨¡å¼

é€™æ˜¯æ•´å€‹å°ˆæ¡ˆæœ€é‡è¦çš„æ¶æ§‹æ¨¡å¼ã€‚Bubble Tea æ¡†æ¶å€Ÿé¡äº† Elm èªè¨€çš„æ¶æ§‹ï¼š

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Model   â”‚  â† æ‡‰ç”¨ç¨‹å¼çš„å…¨éƒ¨ç‹€æ…‹ï¼ˆè³‡æ–™ï¼‰
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                         â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚     View(Model)     â”‚  â† æ ¹æ“šç‹€æ…‹æ¸²æŸ“ç•«é¢ï¼ˆç´”å‡½å¼ï¼‰
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                    ä½¿ç”¨è€…çœ‹åˆ°ç•«é¢
                    ä½¿ç”¨è€…æŒ‰äº†éµç›¤
                         â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Update(Model, Msg) â”‚  â† è™•ç†äº‹ä»¶ï¼Œå›å‚³æ–°ç‹€æ…‹
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                    æ›´æ–° Model â†’ é‡æ–° View â†’ ç„¡é™å¾ªç’°
```

å…·é«”åœ¨ç¨‹å¼ç¢¼ä¸­ï¼ˆ`update.go:13-49`ï¼‰ï¼š

```go
func (m Model) Update(msg tea.Msg) (tea.Model, tea.Cmd) {
    switch msg := msg.(type) {   // Go çš„ type switchï¼šæ ¹æ“šè¨Šæ¯ã€Œå‹åˆ¥ã€åˆ†æ´¾
    case tea.WindowSizeMsg:       // çµ‚ç«¯è¦–çª—å¤§å°æ”¹è®Š
        m.width = msg.Width
        m.height = msg.Height
        return m, nil             // å›å‚³æ–° Model + nilï¼ˆæ²’æœ‰å¾ŒçºŒæŒ‡ä»¤ï¼‰

    case CaptureAppendMsg:        // æˆªå–å·¦é‚Šçª—æ ¼çš„çµæœ
        return m.handleCaptureAppend(string(msg)), nil

    case tea.KeyMsg:              // éµç›¤æŒ‰éµäº‹ä»¶
        if m.inputMode {
            return m.handleInputMode(msg)
        }
        return m.handleBrowseMode(msg)
    }
    return m, nil
}
```

[â¬† å›åˆ°ç›®éŒ„](#ç›®éŒ„)

---

### 8. Type Switch èˆ‡ Type Assertion

> å°æ‡‰æª”æ¡ˆï¼š`update.go:14-46`

```go
switch msg := msg.(type) {    // msg.(type) æ˜¯ Go ç‰¹æœ‰èªæ³•
case tea.WindowSizeMsg:       // å¦‚æœ msg æ˜¯ WindowSizeMsg å‹åˆ¥
    // msg åœ¨é€™å€‹ case è£¡è‡ªå‹•è½‰å‹ç‚º tea.WindowSizeMsg
case tea.KeyMsg:              // å¦‚æœ msg æ˜¯ KeyMsg å‹åˆ¥
    // msg åœ¨é€™è£¡è‡ªå‹•è½‰å‹ç‚º tea.KeyMsg
}
```

é€™æ˜¯å› ç‚º `tea.Msg` æ˜¯ä¸€å€‹**ç©ºä»‹é¢**ï¼ˆ`interface{}`ï¼‰ï¼Œä»»ä½•å‹åˆ¥éƒ½æ»¿è¶³å®ƒã€‚`type switch` è®“ä½ å®‰å…¨åœ°åˆ¤æ–·å¯¦éš›å‹åˆ¥ã€‚

[â¬† å›åˆ°ç›®éŒ„](#ç›®éŒ„)

---

### 9. Closureï¼ˆé–‰åŒ…ï¼‰èˆ‡ tea.Cmd æ¨¡å¼

> å°æ‡‰æª”æ¡ˆï¼š`model.go:62-87`

`tea.Cmd` æ˜¯ä¸€å€‹å‡½å¼å‹åˆ¥ï¼š`func() tea.Msg`ã€‚

```go
func captureVisible(paneID string) tea.Cmd {
    return func() tea.Msg {    // å›å‚³ä¸€å€‹ã€Œé–‰åŒ…ã€â€”â€”å®ƒè¨˜ä½äº† paneID çš„å€¼
        scrollPos := tmuxDisplayVar(paneID, "scroll_position")
        // ... åŸ·è¡Œ tmux æŒ‡ä»¤ ...
        return CaptureAppendMsg(result)  // å›å‚³çµæœè¨Šæ¯ï¼Œæ¡†æ¶æœƒé€é€² Update()
    }
}
```

**è¨­è¨ˆç²¾é«“ï¼š** `tea.Cmd` æ˜¯**éåŒæ­¥å‰¯ä½œç”¨**çš„å®¹å™¨ã€‚View æ˜¯ç´”å‡½å¼ï¼ˆåªç®¡é¡¯ç¤ºï¼‰ï¼ŒUpdate è™•ç†é‚è¼¯ï¼Œè€Œéœ€è¦ I/O çš„å·¥ä½œï¼ˆåŸ·è¡Œå¤–éƒ¨æŒ‡ä»¤ï¼‰åŒ…è£æˆ `Cmd`ï¼Œç”±æ¡†æ¶åœ¨èƒŒæ™¯åŸ·è¡Œå¾ŒæŠŠçµæœé€å› `Update`ã€‚

[â¬† å›åˆ°ç›®éŒ„](#ç›®éŒ„)

---

### 10. è‡ªè¨‚å‹åˆ¥èˆ‡ Msg æ¨¡å¼

> å°æ‡‰æª”æ¡ˆï¼š`model.go:18`

```go
type CaptureAppendMsg string  // å®šç¾©æ–°å‹åˆ¥ï¼ˆåº•å±¤æ˜¯ stringï¼‰
```

Go å¯ä»¥åŸºæ–¼æ—¢æœ‰å‹åˆ¥å»ºç«‹æ–°å‹åˆ¥ã€‚é€™è£¡ `CaptureAppendMsg` åº•å±¤æ˜¯ `string`ï¼Œä½†å®ƒæ˜¯**ç¨ç«‹çš„å‹åˆ¥**ï¼Œå¯ä»¥åœ¨ `type switch` ä¸­è¢«å€åˆ†ã€‚é€™æ˜¯ Bubble Tea çš„è¨Šæ¯å‚³éæ¨¡å¼ã€‚

[â¬† å›åˆ°ç›®éŒ„](#ç›®éŒ„)

---

### 11. åˆ‡ç‰‡æ“ä½œï¼ˆSliceï¼‰

> å°æ‡‰æª”æ¡ˆï¼š`marks.go:15-43`

Go çš„åˆ‡ç‰‡æ˜¯å‹•æ…‹é™£åˆ—ï¼Œæ ¸å¿ƒæ“ä½œï¼š

```go
// æ–°å¢å…ƒç´ 
m.marks = append(m.marks, Mark{Line: line, Text: text})

// åˆªé™¤å…ƒç´ ï¼ˆç”¨åˆ‡ç‰‡æ‹¼æ¥ï¼‰
m.marks = append(m.marks[:i], m.marks[i+1:]...)
//                 å‰åŠéƒ¨åˆ†        å¾ŒåŠéƒ¨åˆ†
//  [:i]   = ç´¢å¼• 0 åˆ° i-1
//  [i+1:] = ç´¢å¼• i+1 åˆ°æœ€å¾Œ
//  ...    = å±•é–‹åˆ‡ç‰‡ï¼ˆæŠŠåˆ‡ç‰‡çš„å…ƒç´ ä¸€å€‹å€‹å‚³å…¥ appendï¼‰
```

**åˆ‡ç‰‡ vs é™£åˆ—ï¼š**

| ç‰¹æ€§ | é™£åˆ— `[5]int` | åˆ‡ç‰‡ `[]int` |
|------|---------------|--------------|
| é•·åº¦ | å›ºå®š | å‹•æ…‹ |
| å‚³é | è¤‡è£½æ•´å€‹é™£åˆ— | å‚³éåƒè€ƒï¼ˆåº•å±¤å…±äº«è¨˜æ†¶é«”ï¼‰ |
| ä½¿ç”¨é »ç‡ | å¾ˆå°‘ | å¹¾ä¹ç¸½æ˜¯ç”¨åˆ‡ç‰‡ |

[â¬† å›åˆ°ç›®éŒ„](#ç›®éŒ„)

---

### 12. éŒ¯èª¤è™•ç† â€” Go çš„ç¨ç‰¹å“²å­¸

> å°æ‡‰æª”æ¡ˆï¼š`session.go:25-62`

Go **æ²’æœ‰ try-catch**ï¼Œç”¨å¤šå›å‚³å€¼è™•ç†éŒ¯èª¤ï¼š

```go
func launchSession(cli string) error {    // å›å‚³å€¼æ˜¯ error ä»‹é¢
    self, err := os.Executable()           // å¤šå›å‚³å€¼ï¼š(string, error)
    if err != nil {                        // Go çš„æ…£ä¾‹ï¼šæ¯æ¬¡å‘¼å«éƒ½ç«‹å³æª¢æŸ¥ err
        return fmt.Errorf("failed to get executable path: %w", err)
        //     %w = åŒ…è£åŸå§‹éŒ¯èª¤ï¼ˆerror wrappingï¼‰
    }
    // ... æ­£å¸¸é‚è¼¯ ...
}
```

**è¨­è¨ˆç†å¿µï¼š** éŒ¯èª¤æ˜¯å€¼ï¼ˆvalueï¼‰ï¼Œä¸æ˜¯ä¾‹å¤–ï¼ˆexceptionï¼‰ã€‚å¼·è¿«é–‹ç™¼è€…åœ¨æ¯å€‹å¯èƒ½å¤±æ•—çš„åœ°æ–¹æ˜ç¢ºè™•ç†ã€‚

**å¸¸è¦‹çš„éŒ¯èª¤è™•ç†æ¨¡å¼ï¼š**

```go
// æ¨¡å¼ 1ï¼šå›å‚³éŒ¯èª¤çµ¦å‘¼å«è€…
if err != nil {
    return fmt.Errorf("context message: %w", err)
}

// æ¨¡å¼ 2ï¼šå¿½ç•¥éŒ¯èª¤ï¼ˆç”¨ _ æ˜ç¢ºè¡¨ç¤ºï¼‰
_ = exec.Command("tmux", "kill-session", "-t", name).Run()

// æ¨¡å¼ 3ï¼šéŒ¯èª¤æ™‚ç›´æ¥çµæŸç¨‹å¼
if _, err := p.Run(); err != nil {
    fmt.Fprintf(os.Stderr, "TUI error: %v\n", err)
    os.Exit(1)
}
```

[â¬† å›åˆ°ç›®éŒ„](#ç›®éŒ„)

---

### 13. è®Šæ•¸å®£å‘Šçš„å¤šç¨®æ–¹å¼

```go
var keys = KeyMap{...}           // var å®£å‘Š + åˆå§‹å€¼ï¼ˆå¥—ä»¶å±¤ç´šï¼‰
const noteInputHeight = 4       // å¸¸æ•¸å®£å‘Š

func example() {
    clis := detectCLIs()         // := çŸ­è®Šæ•¸å®£å‘Šï¼ˆå‹åˆ¥è‡ªå‹•æ¨æ–·ï¼Œåªèƒ½åœ¨å‡½å¼å…§ç”¨ï¼‰
    var found []string           // var å®£å‘Šï¼ˆnil åˆ‡ç‰‡ï¼‰
    sessionName := "ai-review"   // := æœ€å¸¸ç”¨çš„å¯«æ³•
}
```

**å®£å‘Šæ–¹å¼æ¯”è¼ƒï¼š**

| èªæ³• | ä½¿ç”¨å ´æ™¯ | ç¯„ä¾‹ |
|------|----------|------|
| `var x Type` | å¥—ä»¶å±¤ç´š / éœ€è¦æ˜ç¢ºå‹åˆ¥ | `var found []string` |
| `x := value` | å‡½å¼å…§ï¼Œå‹åˆ¥è‡ªå‹•æ¨æ–· | `name := "hello"` |
| `const x = value` | ä¸å¯è®Šå¸¸æ•¸ | `const maxLen = 60` |

[â¬† å›åˆ°ç›®éŒ„](#ç›®éŒ„)

---

### 14. éˆå¼æ–¹æ³•å‘¼å«ï¼ˆMethod Chainingï¼‰

> å°æ‡‰æª”æ¡ˆï¼š`view.go:11-33`

lipgloss çš„ Builder Patternï¼š

```go
var borderStyle = lipgloss.NewStyle().
    Border(lipgloss.RoundedBorder()).   // åœ“è§’é‚Šæ¡†
    BorderForeground(lipgloss.Color("62"))  // é‚Šæ¡†é¡è‰²

var cursorStyle = lipgloss.NewStyle().
    Bold(true).                         // ç²—é«”
    Foreground(lipgloss.Color("212"))   // å‰æ™¯è‰²
```

æ¯å€‹æ–¹æ³•éƒ½å›å‚³ `lipgloss.Style`ï¼Œæ‰€ä»¥å¯ä»¥ä¸€ç›´ä¸²ä¸‹å»ã€‚

[â¬† å›åˆ°ç›®éŒ„](#ç›®éŒ„)

---

## å°ˆæ¡ˆæ¶æ§‹ç¸½çµ

| æª”æ¡ˆ | è·è²¬ | æ¶µè“‹çš„ Go æ¦‚å¿µ |
|------|------|----------------|
| `main.go` | ç¨‹å¼é€²å…¥é»ã€å•Ÿå‹•é‚è¼¯ | `package main`, `func main()`, å‘½ä»¤åˆ—åƒæ•¸ |
| `model.go` | è³‡æ–™æ¨¡å‹ + æ“·å–é‚è¼¯ | struct, å»ºæ§‹å‡½å¼, closure, interface å¯¦ä½œ |
| `view.go` | ç•«é¢æ¸²æŸ“ | æ–¹æ³•ï¼ˆå€¼æ¥æ”¶è€…ï¼‰, å­—ä¸²æ“ä½œ, æ¨£å¼ |
| `update.go` | äº‹ä»¶è™•ç† | type switch, ç‹€æ…‹æ©Ÿ, å¤šå›å‚³å€¼ |
| `keys.go` | å¿«æ·éµå®šç¾© | struct literal, å¥—ä»¶å±¤ç´šè®Šæ•¸ |
| `marks.go` | æ¨™è¨˜çš„ CRUD | æŒ‡æ¨™æ¥æ”¶è€…, åˆ‡ç‰‡æ“ä½œ, strings.Builder |
| `session.go` | tmux æœƒè©±ç®¡ç† | os/exec, éŒ¯èª¤è™•ç†, ç’°å¢ƒè®Šæ•¸ |
| `clipboard.go` | å‰ªè²¼ç°¿ / è²¼ä¸ŠåŠŸèƒ½ | ç¬¬ä¸‰æ–¹å¥—ä»¶å‘¼å«, æŒ‡æ¨™æ–¹æ³• |

[â¬† å›åˆ°ç›®éŒ„](#ç›®éŒ„)

---

## ç¨‹å¼åŸ·è¡Œæµç¨‹

```
1. main() å•Ÿå‹•
   â”œâ”€ --help        â†’ å°å‡ºä½¿ç”¨èªªæ˜
   â”œâ”€ --internal-watch <paneID>  â†’ å•Ÿå‹•æ¨™è¨»é¢æ¿ TUIï¼ˆç”± tmux å…§éƒ¨å‘¼å«ï¼‰
   â””â”€ ç„¡åƒæ•¸ï¼ˆé è¨­ï¼‰  â†’ runLauncher()
       â”œâ”€ detectCLIs()  åµæ¸¬å·²å®‰è£çš„ AI CLIï¼ˆclaude, gemini, codex, aiderï¼‰
       â””â”€ launchSession(cli)
           â”œâ”€ å»ºç«‹ tmux session "ai-review"
           â”œâ”€ å·¦çª—æ ¼åŸ·è¡Œ AI CLI
           â”œâ”€ å³çª—æ ¼åŸ·è¡Œ ai-review --internal-watchï¼ˆè‡ªå·±ï¼‰
           â””â”€ attach åˆ° sessionï¼ˆä½¿ç”¨è€…é–‹å§‹äº’å‹•ï¼‰

2. æ¨™è¨»é¢æ¿ TUI å¾ªç’°ï¼ˆThe Elm Architectureï¼‰
   Modelï¼ˆç‹€æ…‹ï¼‰â†’ Viewï¼ˆæ¸²æŸ“ï¼‰â†’ ä½¿ç”¨è€…æŒ‰éµ â†’ Updateï¼ˆæ›´æ–°ç‹€æ…‹ï¼‰â†’ é‡è¤‡

3. ä½¿ç”¨è€…æ“ä½œ
   r â†’ æ“·å–å·¦çª—æ ¼å…§å®¹åˆ°å³é‚Š
   j/k â†’ ä¸Šä¸‹ç§»å‹•æ¸¸æ¨™
   m â†’ æ¨™è¨˜ç•¶å‰è¡Œ
   c â†’ æ¨™è¨˜ + å¯«è¨»è§£
   S â†’ åŒ¯å‡ºæ‰€æœ‰æ¨™è¨˜åˆ°å‰ªè²¼ç°¿
   P â†’ å°‡æ¨™è¨˜è²¼å›å·¦çª—æ ¼
   q â†’ é›¢é–‹
```

[â¬† å›åˆ°ç›®éŒ„](#ç›®éŒ„)
